---
# MPIJob with Volcano gang scheduling
# This manifest demonstrates gang scheduling integration with Volcano
apiVersion: kubeflow.org/v2
kind: MPIJob
metadata:
  name: volcano-gang-scheduling-test
  namespace: default
  labels:
    app: mpijob
    test: volcano-scheduling
    scheduling: gang
spec:
  slotsPerWorker: 2
  mpiImplementation: OpenMPI
  runPolicy:
    cleanPodPolicy: Running
    ttlSecondsAfterFinished: 300
    schedulingPolicy:
      priorityClass: high-priority
      queue: default
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      restartPolicy: OnFailure
      template:
        metadata:
          annotations:
            scheduling.volcano.sh/group-name: volcano-gang-scheduling-test
        spec:
          schedulerName: volcano
          containers:
          - name: mpi-launcher
            image: docker.io/kubeflow/mpi-horovod-example:latest
            command:
            - mpirun
            - --allow-run-as-root
            - -np
            - "8"
            - --host
            - volcano-gang-scheduling-test-worker-0:2,volcano-gang-scheduling-test-worker-1:2,volcano-gang-scheduling-test-worker-2:2,volcano-gang-scheduling-test-worker-3:2
            - python
            - /examples/tensorflow_mnist.py
            resources:
              requests:
                cpu: "1"
                memory: "2Gi"
              limits:
                cpu: "2"
                memory: "4Gi"
    Worker:
      replicas: 4
      restartPolicy: OnFailure
      template:
        metadata:
          annotations:
            scheduling.volcano.sh/group-name: volcano-gang-scheduling-test
        spec:
          schedulerName: volcano
          containers:
          - name: mpi-worker
            image: docker.io/kubeflow/mpi-horovod-example:latest
            command:
            - /usr/sbin/sshd
            - -De
            - -f
            - /home/mpiuser/.sshd_config
            resources:
              requests:
                cpu: "2"
                memory: "4Gi"
              limits:
                cpu: "4"
                memory: "8Gi"
