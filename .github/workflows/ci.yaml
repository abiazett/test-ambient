name: MPIJob CI

on:
  push:
    branches: [ main ]
    paths:
      - 'kubernetes/**'
      - 'cli/**'
      - 'sdk/**'
      - 'api/**'
      - 'service/**'
      - 'operator/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'kubernetes/**'
      - 'cli/**'
      - 'sdk/**'
      - 'api/**'
      - 'service/**'
      - 'operator/**'
      - '.github/workflows/**'

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Unit tests for operator
        run: |
          cd operator
          go test -v ./...

      - name: Unit tests for API
        run: |
          cd api
          go test -v ./...

      - name: Unit tests for CLI
        run: |
          cd cli
          go test -v ./...

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Unit tests for SDK
        run: |
          cd sdk
          pip install -e .[test]
          pytest -xvs

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Go linting
        uses: golangci/golangci-lint-action@v3
        with:
          working-directory: cli
          args: --timeout=5m

      - name: Go linting (operator)
        uses: golangci/golangci-lint-action@v3
        with:
          working-directory: operator
          args: --timeout=5m

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Python linting
        run: |
          pip install flake8 black
          flake8 sdk
          black --check sdk

      - name: Kubernetes manifest validation
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.6.1/kubeconform-linux-amd64.tar.gz | tar xz
          ./kubeconform -summary kubernetes/**/*.yaml

  build:
    runs-on: ubuntu-latest
    needs: [unit-tests, lint]
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Build CLI
        run: |
          cd cli
          go build -v -o bin/odh-mpijob ./cmd/...

      - name: Build operator
        run: |
          cd operator
          go build -v -o bin/mpijob-controller ./...

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build SDK
        run: |
          cd sdk
          pip install build
          python -m build

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: mpijob-artifacts
          path: |
            cli/bin/odh-mpijob
            operator/bin/mpijob-controller
            sdk/dist/*.whl
            frontend/build/
          retention-days: 7

  integration-tests:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v3

      - name: Set up Kind cluster
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: "v0.17.0"

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: mpijob-artifacts

      - name: Install KubeFlow Training Operator
        run: |
          kubectl apply -f https://github.com/kubeflow/training-operator/releases/download/v1.5.0/training-operator.yaml
          kubectl wait --for=condition=available --timeout=300s deployment/training-operator -n kubeflow

      - name: Install CRDs
        run: |
          kubectl apply -f kubernetes/crds/mpijob_crd.yaml

      - name: Run integration tests
        run: |
          cd test/integration
          go test -v -timeout 20m ./...

  publish-images:
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Container Registry
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build and push Operator image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: operator/Dockerfile
          push: true
          tags: quay.io/openshiftai/mpijob-operator:latest

      - name: Build and push CLI image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: cli/Dockerfile
          push: true
          tags: quay.io/openshiftai/mpijob-cli:latest